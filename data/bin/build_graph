#!/usr/bin/env python

import click

from collections import OrderedDict
from textplot.utils import sort_dict
from textplot.text import Text
from textplot.matrix import Matrix
from humanist.graphs import Diachronic


@click.command()
@click.option('--freq_depth',   default=3000)
@click.option('--bandwidth',    default=100000)
@click.option('--spike_depth',  default=1000)
@click.option('--skim_depth',   default=10)
def build_graph(freq_depth, spike_depth, skim_depth, bandwidth):

    print 'Tokenizing corpus...'
    t = Text.from_file('corpus.txt')
    m = Matrix(t)

    # Get the top X most frequent terms.
    frequent = t.most_frequent_terms(freq_depth)

    print 'Computing KDE maxima...'
    spiky = OrderedDict()
    for term in frequent:
        spiky[term] = t.kde_max(term, bandwidth=bandwidth)

    # Sort by KDE max.
    spiky = sort_dict(spiky)

    print 'Indexing terms:'
    m.index(spiky.keys()[:spike_depth], bandwidth=bandwidth)

    g = Diachronic()

    print 'Generating graph:'
    g.build(m, skim_depth, bandwidth=bandwidth)
    g.write_gml('build/graph.gml')


if __name__ == '__main__':
    build_graph()
